<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Hotswap</title>
    <link rel="stylesheet" href="../css/default.css">
  </head>
  <body>
    <div id="main">
      <div id="header">
        <div id="navigation">
          <a class="btn" href="../">Home</a>
          <a class="btn" href="../posts">Posts</a>
          <a class="btn" href="../projects">Projects</a>
          <a class="btn" href="../gallery">Gallery</a>
          <a class="btn" href="../resume.html">Resume</a>
          <a class="btn rss" href="../feed.xml">RSS</a>
        </div>
        <div id="title">
          <h1>Hotswap</h1>
        </div>
      </div>
      <div id="content">
        <p><a href="https://github.com/mikeplus64/hotswap">GitHub project</a>.</p>
<p><a href="http://hackage.haskell.org/package/hotswap">Hotswap</a> is a simple, high level interface to <a href="http://hackage.haskell.org/package/plugins">plugins</a> for hotswapping Haskell code in a simple and automatable manner.</p>
<h3 id="demo-application-gambling.">Demo application: gambling.</h3>
<h4 id="main.hs">Main.hs</h4>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">System.Plugins.Hotswap</span>
<span class="kw">import </span><span class="dt">System.IO</span> (hSetBuffering, stdout, <span class="dt">BufferMode</span> (<span class="dt">NoBuffering</span>))

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
    hSetBuffering stdout <span class="dt">NoBuffering</span>
    inputHandler <span class="ot">&lt;-</span> newPlugin <span class="st">&quot;Plugin.o&quot;</span> [] <span class="st">&quot;inputHandler&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Plugin</span> (<span class="dt">IO</span> <span class="dt">Bool</span>))
    forever <span class="fu">$</span> <span class="kw">do</span>
        r <span class="ot">&lt;-</span> runPlugin inputHandler
        when r <span class="fu">$</span> reloadPlugin inputHandler</code></pre></div>
<h4 id="plugin.hs">Plugin.hs</h4>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Plugin</span> <span class="kw">where</span>
<span class="kw">import </span><span class="dt">System.Random</span> (randomRIO)

<span class="ot">inputHandler ::</span> <span class="dt">IO</span> <span class="dt">Bool</span>
inputHandler <span class="fu">=</span> <span class="kw">do</span>
    putStrLn <span class="st">&quot;Guess a number between 0 and 10. Guess -1 to reload the plugin.&quot;</span>
    g <span class="ot">&lt;-</span> fmap read<span class="ot"> getLine ::</span> <span class="dt">IO</span> <span class="dt">Int</span>

    <span class="kw">if</span> g <span class="fu">==</span> <span class="fu">-</span><span class="dv">1</span>
        <span class="kw">then</span> <span class="kw">do</span>
            putStrLn <span class="st">&quot;Reloading ...&quot;</span>
            return <span class="dt">True</span>
        <span class="kw">else</span> <span class="kw">do</span>
            r <span class="ot">&lt;-</span> randomRIO (<span class="dv">0</span>, <span class="dv">10</span>)<span class="ot"> ::</span> <span class="dt">IO</span> <span class="dt">Int</span>
            <span class="kw">if</span> g <span class="fu">==</span> r
                <span class="kw">then</span> putStrLn <span class="st">&quot;Congratulations! You win nothing!&quot;</span>
                <span class="kw">else</span> putStrLn <span class="st">&quot;Wrong! You lose nothing, but bring shame to your people.&quot;</span>
            return <span class="dt">False</span></code></pre></div>
<p>Then, to compile and run this, I run in a shell:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> ghc --make -O2 -threaded Main
[<span class="kw">1</span> of 1] Compiling Main             ( Main.hs, Main.o )
<span class="kw">Linking</span> Main ...
<span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> ghc Plugin
[<span class="kw">1</span> of 1] Compiling Plugin           ( Plugin.hs, Plugin.o )
<span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> ./Main <span class="co"># example run:</span>
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">5</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">4</span>
<span class="kw">Congratulations</span>! You win nothing!
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">3</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">5</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">6</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">1</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">-1</span>
<span class="kw">Reloading</span> ...
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
^<span class="kw">Z</span>
<span class="kw">zsh</span>: suspended  ./Main</code></pre></div>
<p>Pretty mundane. But, lets say I want to change what happens when you guess incorrectly.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> sed -i -e <span class="st">&quot;s/else putStrLn.*/else putStrLn </span><span class="dt">\&quot;</span><span class="st">HAHA, YOU'RE HORRIBLE</span><span class="dt">\&quot;</span><span class="st">/g&quot;</span> Plugin.hs
<span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> ghc Plugin
[<span class="kw">1</span> of 1] Compiling Plugin           ( Plugin.hs, Plugin.o )
<span class="kw">~/code/projects/hotswap</span>/<span class="kw">examples&gt;</span> fg
[<span class="kw">1</span>]  + continued  ./Main
<span class="kw">5</span>
<span class="kw">Wrong</span>! You lose nothing, but bring shame to your people.
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">-1</span>
<span class="kw">Reloading</span> ...
<span class="kw">Guess</span> a number between 0 and 10. Guess -1 to reload the plugin.
<span class="kw">4</span>
<span class="kw">HAHA</span>, YOU<span class="st">'RE HORRIBLE</span>
<span class="st">Guess a number between 0 and 10. Guess -1 to reload the plugin.</span></code></pre></div>
<p>And there we have it, hotswapping!</p>
<h3 id="todo">Todo</h3>
<ul>
<li>Entirely automatic hotswapping:
<ul>
<li>Specify a source file; it gets compiled for you, and is watched for changes</li>
<li>A good, cross platform and fast file watching library.</li>
</ul></li>
<li>More examples!</li>
</ul>

      </div>
    </div>
  </body>
</html>
